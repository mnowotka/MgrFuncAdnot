{% extends "base.html" %}

{% block extrahead %}
  {% load jquery_ui_tags %}
  {% include_jquery_ui %}
  {% include_jquery_notification %}
  {% load dajaxice_templatetags %}
  {% dajaxice_js_import %}
  <script>
  
  function notify(data){
   
    $.pnotify({
						pnotify_title: data.title,
						pnotify_type: data.type,
						pnotify_text: data.message
					});
  }
  
  function pause(target)
  {
    $(target).button("option", {
      icons: { primary: "ui-icon-play" }
    }).unbind('click');
    
    $( target ).click(function()
    {
      var that = this;
      Dajaxice.gui.startTask
      (
        function(data)
        {
          play(that); 
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });    
  }
  
  function play(target)
  {
    $(target).button("option", {
      icons: { primary: "ui-icon-pause" }
    }).unbind('click');
    
    $( target ).click(function()
    {
      var that = this;
      Dajaxice.gui.pauseTask
      (
        function(data)
        {
          pause(that); 
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });    
  }
  
  function stop(target)
  {
    pause($('button.pause',$(target).closest('tr')));
  }
  
  function trash(target)
  {
    $(target).closest('tr').remove();
  }
    
	$(function() {
	
  	$( "button.play" ).button({
            icons: {
                primary: "ui-icon-play"
            },
            text: false
        });
        
    $( "button.pause" ).button({
            icons: {
                primary: "ui-icon-pause"
            },
            text: false
    });     
    
  	$( "button.stop" ).button({
            icons: {
                primary: "ui-icon-stop"
            },
            text: false
        });
        
		$( "button.trash" ).button({
            icons: {
                primary: "ui-icon-trash"
            },
            text: false
        });
    
    $( "button.play" ).click(function()
    {
      var that = this;
      Dajaxice.gui.startTask
      (
        function(data)
        {
          play(that); 
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });
    
    $( "button.pause" ).click(function()
    {
      var that = this;
      Dajaxice.gui.pauseTask
      (
        function(data)
        {
          pause(that); 
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });
    
    $( "button.stop" ).click(function()
    {
      var that = this;
      Dajaxice.gui.stopTask
      (
        function(data)
        {
          stop(that);
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });
    
    $( "button.trash" ).click(function() 
    {
      var that = this;
      Dajaxice.gui.deleteTask
      (
        function(data)
        {
          trash(that);
          notify(data);
        }, 
        {'name':$('td:eq(0)',$(this).closest('tr')).text()}
      );
    });     	
        
    $( ".progressbar" ).progressbar({
			value: $(this).text()
		});                    
  });
	</script>
{% endblock %}

{% block content %}
  <div class="module" id="changelist">
    <h2>Tasks</h2>
    <table id="result_list">
       <thead>
       <tr>
         <th>Name</th>
         <th>Subtasks count</th>
         <th>Progress</th>
         <th>File Name</th>
         <th></th>
         <th></th>
         <th></th>
       </tr>
       </thead>
        {% for task in object_list %}
        <tr class="{% cycle 'row1' 'row2' %}" style="height:50px;">
          <td>{{ task.task_name }}</td>
          <td>{{ task.subtasks }}</td>
          <td style="width:200px;"><div class="progressbar">{{ task.progress }}</div></td>
          <td>{{ task.filename }}</td>
          <td>
            {% if task.paused %}
              <button class="play">Start task</button>
            {% else %}
              <button class="pause">Pause task</button>
            {% endif %}
          </td>
          <td>
            <button class="stop" >Stop task</button>
          </td>
          <td>
            <button class="trash" >Delete task</button>
          </td>          
        </tr>
        {% endfor %}
    </table>
  </div>  
{% endblock %}

